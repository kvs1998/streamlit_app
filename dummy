SHOW TASKS LIKE 'task%';

SELECT "name", "state", "last_scheduled_time", "last_successful_completion_time"
FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));


-- columns in A but not B
SELECT 'IN_A_NOT_IN_B' as source, column_name, data_type
FROM information_schema.columns
WHERE table_catalog='DB' AND table_schema='SCHEMA' AND table_name='TABLE_A'
MINUS
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_catalog='DB' AND table_schema='SCHEMA' AND table_name='TABLE_B';

-- columns in B but not A
SELECT 'IN_B_NOT_IN_A' as source, column_name, data_type
FROM information_schema.columns
WHERE table_catalog='DB' AND table_schema='SCHEMA' AND table_name='TABLE_B'
MINUS
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_catalog='DB' AND table_schema='SCHEMA' AND table_name='TABLE_A';



SET target_word = 'nanosecond'; -- Or 'microsecond', or any other word you want to find

-- Create a TEMPORARY table to store your list of objects.
-- This table is session-bound and automatically dropped when the session ends.
CREATE OR REPLACE TEMPORARY TABLE MY_OBJECT_LIST (
    OBJECT_NAME VARCHAR(255)
);

-- Insert your object names into the temporary table
INSERT INTO MY_OBJECT_LIST (OBJECT_NAME) VALUES
    ('YOUR_TABLE_1'),
    ('YOUR_VIEW_2'),
    ('YOUR_TABLE_3');
    -- Add all your objects here

-- Create another TEMPORARY table to store the messages we want to "print".
-- This will hold our results before the final SELECT.
CREATE OR REPLACE TEMPORARY TABLE DDL_CHECK_MESSAGES (
    MESSAGE_TEXT VARCHAR(1000)
);



BEGIN
  -- Target word to find in DDLs
  LET target_word STRING := 'nanosecond';

  -- Create temporary tables
  EXECUTE IMMEDIATE '
    CREATE OR REPLACE TEMPORARY TABLE MY_OBJECT_LIST (OBJECT_NAME VARCHAR(255))
  ';

  EXECUTE IMMEDIATE '
    INSERT INTO MY_OBJECT_LIST (OBJECT_NAME) VALUES
      (''YOUR_TABLE_1''), 
      (''YOUR_VIEW_2''), 
      (''YOUR_TABLE_3'')
  ';

  EXECUTE IMMEDIATE '
    CREATE OR REPLACE TEMPORARY TABLE DDL_CHECK_MESSAGES (MESSAGE_TEXT VARCHAR(1000))
  ';

  -- Declare block variables
  DECLARE
      object_cursor CURSOR FOR SELECT OBJECT_NAME FROM MY_OBJECT_LIST;
      object_name_var STRING;
      ddl_result STRING;
      found_count NUMBER := 0;
      insert_message_sql STRING;
  BEGIN
      FOR object_row IN object_cursor DO
          object_name_var := object_row.OBJECT_NAME;

          ddl_result := GET_DDL('TABLE', object_name_var);

          IF (ddl_result ILIKE '%' || target_word || '%') THEN
              found_count := found_count + 1;
              insert_message_sql := 
                  'INSERT INTO DDL_CHECK_MESSAGES (MESSAGE_TEXT) VALUES (''Object "' 
                  || object_name_var || '" DDL contains "' || target_word || '".'')';
              EXECUTE IMMEDIATE insert_message_sql;
          END IF;
      END FOR;

      -- Insert summary
      IF (found_count = 0) THEN
          insert_message_sql := 
              'INSERT INTO DDL_CHECK_MESSAGES (MESSAGE_TEXT) VALUES (''No objects found containing "' 
              || target_word || '" in their DDL.'')';
          EXECUTE IMMEDIATE insert_message_sql;
      ELSE
          insert_message_sql := 
              'INSERT INTO DDL_CHECK_MESSAGES (MESSAGE_TEXT) VALUES (''' 
              || found_count || ' object(s) found containing "' || target_word || '" in their DDL.'')';
          EXECUTE IMMEDIATE insert_message_sql;
      END IF;
  END;
END;

-- Finally view results
SELECT MESSAGE_TEXT FROM DDL_CHECK_MESSAGES ORDER BY MESSAGE_TEXT;
